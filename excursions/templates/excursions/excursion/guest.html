{% load thumbnail static %}
<div>
    <a class="hidden-lg hidden-md hidden-sm" href="{% url "excursions.views.category" current_excursion.category.pk %}">
        <button class="btn btn-sm btn-default"
                style="margin-bottom: 5px">{{ current_excursion.category.title }} </button>
    </a>
</div>

<h2 id="excursion-title" style="margin-bottom: 0.25em">
    {{ current_excursion.title|default:"..." }}
</h2>
<hr>

<!-- ГАЛЕРЕЯ -->

{% if gallery %}
    <div class="excursion-gallery guest">
        {% thumbnail current_excursion.img_preview 0x150 as thumb %}
        {% thumbnail current_excursion.img_preview 1024x400 as thumb_big %}
        <div class="excursion-gallery-item active"
             data-thumb-src="{{ thumb_big.url }}" data-src="{{ current_excursion.img_preview.url }}">
            <div>
                <img src="{{ thumb.url }}"/>
            </div>
        </div>
        {% for img in gallery %}
            {% thumbnail img.image 0x150 as thumb %}
            {% thumbnail img.image 1024x400 as thumb_big %}
            <div class="excursion-gallery-item"
                 data-thumb-src="{{ thumb_big.url }}" data-src="{{ img.image.url }}">
                <div>
                    <img src="{{ thumb.url }}"/>
                </div>
            </div>
        {% endfor %}
    </div>
{% endif %}

<!-- КОНТЕЙНЕР С ИЗОБРАЖЕНИЕМ -->
{% if current_excursion.img_preview %}
    <div class="excursion-preview-container{% if not gallery %} without-items{% endif %}">
        {#        <span class="preview-container-helper"></span>#}
        <a href="{{ current_excursion.img_preview.url }}">
            {% thumbnail current_excursion.img_preview 1024x400 as thumb %}
            <img class="lazy fadein main-image" data-original="{{ thumb.url }}"/>
        </a>
    </div>
{% endif %}
<!-- конец КОНТЕЙНЕР С ИЗОБРАЖЕНИЕМ -->
<div style="clear:right"></div>

<hr>
<!-- конец ГАЛЕРЕЯ -->

<!-- ОПИСАНИЕ -->
<div id="excursion-description">
    {{ current_excursion.description|safe|default:"..." }}
</div>
<!-- конец ОПИСАНИЕ -->

<!-- ЦЕНЫ -->
{% if current_excursion.priceList %}
    <hr>
    <h3>Рассчитать цену:</h3>
    <form class="form-inline" id="price-calculator">
        <div class="input-group">
            <span class="input-group-addon">Взрослых</span>
            <input type="text" class="form-control" name="adults_count" placeholder="0" value="1"/>
        </div>
        <div class="input-group">
            <span class="input-group-addon">Детей</span>
            <input type="text" class="form-control" name="children_count" placeholder="0" value="12"/>
        </div>
        = <label id="priceOut">0</label> руб.
    </form>
    <hr>
    {#    <noscript>#}
    <div class="hidden-sm hidden-xs hidden-md">
        <h3>Цены:</h3>

        <div id="excursion-price-list">
            <table class="table">
                <thead>
                <tr>
                    <td>Кол-во человек в группе</td>
                    {% for k, v in current_excursion.price_list_rendered %}
                        <td>{{ k }}</td>
                    {% endfor %}
                </tr>
                </thead>
                <tbody>
                <tr>
                    <td>Цена в расчете на человека, руб.</td>
                    {% for k, v in current_excursion.price_list_rendered %}
                        <td>{{ v }}</td>
                    {% endfor %}
                </tr>
                </tbody>
            </table>
        </div>
    </div>
    {#    </noscript>#}
{% endif %}
<!-- конец ЦЕНЫ -->

<script>
    var galleryItems = $(".excursion-gallery-item");
    galleryItems.on("click", function () {
        $(".main-image").attr("src", this.dataset.thumbSrc)
                .parent().attr("href", this.dataset.src);
        galleryItems.removeClass("active");
        $(this).addClass("active");
    });

    var price_list = {{ price_list }};
    var item, price;
    var formPriceCalculator = document.forms['price-calculator'];
    var compute_price = function () {
        var adults_count = parseInt(formPriceCalculator.adults_count.value) || 0;
        var children_count = parseInt(formPriceCalculator.children_count.value) || 0;
        var ppl_count = adults_count + children_count;
        for (var i = 0; i < price_list.length; ++i) {
            item = price_list[i];
            if (item[0] <= ppl_count && ppl_count <= item[1]) {
                console.log(item);
                price = adults_count * item[3] + children_count * item[2] + item[4];
                $("#priceOut").text(price);
                return;
            }
        }
        item = price_list[price_list.length - 1];
        price = adults_count * item[3] + children_count * item[2] + item[4];
        $("#priceOut").text(price);
    };

    $(formPriceCalculator).find("input[type=text]").on("input change", compute_price);
    compute_price();


</script>

