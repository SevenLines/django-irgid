{% load static sekizai_tags %}
{#<form id="excursion-save-form" method="post" action="{% url "excursions.views.ajax.excursion_save" %}">#}
<div id="excursion-content">
    {#    <div class="exursion-content-imagelist" style="width:200px;float: right">#}
    {#        Cool#}
    {#    </div>#}
    {#    {% with current_excursion.img_previews as object %}#}
    {#        {% include "admin/filer/widgets/admin_file.html" %}#}
    {#    {% endwith %}#}
    <form class="excursion-form" action="{% url "excursions.views.ajax.excursion_save" %}">
        <button style="margin-bottom: 0.5em" type="submit"
                class="excursion-content-submit btn btn-default pull-right">
            <span class="glyphicon glyphicon-save"> Сохранить</span>
        </button>

        <div style="clear:right"></div>

        <div class="" style="">
            <table style="width: 100%;table-layout: fixed">
                <tr>
                    <td style="width:66%;">
                        <h2 contenteditable="true" id="excursion-title">{{ current_excursion.title|default:"..." }}</h2>

                        <div id="excursion-short-description" contenteditable="true">
                            {{ current_excursion.short_description|safe|default:"..." }}
                        </div>
                    </td>
                    <td>
                        <div>
                            <img name="image"
                                 src="{% if current_excursion.img_preview %}
                                    {{ current_excursion.img_preview.url }}
                                 {% endif %}"
                                 style="height: 6em"/>
                            <input type="file" name="small_image" class="image-selector" style="display: none;">
                        </div>
                        {#                    </form>#}
                    </td>
                </tr>
            </table>

            <div class="excursion-gallery">
                <div class="excursion-gallery-item"><img src=""></div>
                <div class="excursion-gallery-item"><img src=""></div>
                <div class="excursion-gallery-item"><img src=""></div>
                <div class="excursion-gallery-item"><img src=""></div>
                <div class="excursion-gallery-item"><img src=""></div>
            </div>
            <div style="clear:right"></div>
            {#        <form name="big_image">#}
{#            <div style="text-align: center;padding: 1em 0">#}
{#                <img name="image"#}
{#                     src="{% if current_excursion.image %}#}
{#                            {{ current_excursion.image.url }}#}
{#                        {% endif %}"#}
{#                     style="max-width:100%;max-height: 400px"/>#}
{##}
{#                <div style="padding-top: 0.5em;font-style: italic" contenteditable="true">#}
{#                    подпись#}
{#                </div>#}
{#                <input type="file" name="big_image" class="image-selector" style="display: none;">#}
{#            </div>#}

            <div contenteditable="true" contenteditable="true" id="excursion-description">
                {{ current_excursion.description|safe|default:"..." }}
            </div>

            <h3>Цены:</h3>
            <textarea style="max-width: 100%;min-width: 100%; min-height: 10em" class="form-control"
                      id="excursion-price-list"
                      name="priceList">{{ current_excursion.priceList|safe }}</textarea>
        </div>

        <hr>

        <button type="submit" class="excursion-content-submit btn btn-default pull-right"
                data-action="{% url "excursions.views.ajax.excursion_save" %}">
            <span class="glyphicon glyphicon-save"> Сохранить</span>
        </button>
    </form>
    {% addtoblock "footerjs" %}
        <script src="{% static "bower/ckeditor/ckeditor.js" %}"></script>
    {% endaddtoblock %}

    {% addtoblock "footerjs" %}
        <script>
            var editor_config = {
                enterMode: CKEDITOR.ENTER_BR,
                extraPlugins: 'sourcedialog,showblocks,justify,colordialog,colorbutton,liststyle'
            };

            CKEDITOR.disableAutoInline = true;
            CKEDITOR.inline('excursion-description', editor_config);

            $(".excursion-form").submit(function () {
                var title = $("#excursion-title").html();
                var description = $("#excursion-description").html();
                var short_description = $("#excursion-short-description").html();
                var price_list = $("#excursion-price-list")[0].value;

                var formData = new FormData();
                formData.append("small_image", this.small_image.files[0]);
                formData.append("big_image", this.big_image.files[0]);
                formData.append("id", {{ current_excursion.id }});
                formData.append("csrfmiddlewaretoken", '{{ csrf_token }}');
                formData.append("title", title.trim());
                formData.append("description", description.trim());
                formData.append("short_description", short_description.trim());
                formData.append("price_list", price_list.trim());

                $.ajax({
                    url: this.action,
                    type: "POST",
                    data: formData,
                    processData: false,
                    contentType: false
                }).done(function () {
                    InterfaceAlerts.showSuccess();
                }).fail(function () {
                    InterfaceAlerts.showFail();
                });

                return false;
            });

            {#            $(".image-selector")#}

            $(".image-selector").on("change", function () {
                var that = this;
                if (that.files.length > 0) {
                    var file = that.files[0];
                    var fileReader = new FileReader();
                    fileReader.onload = function (e) {
                        $(that).siblings("img")[0].src = e.target.result;
                    };
                    fileReader.readAsDataURL(file);
                }
            }).each(function (i, item) {
                var that = this;
                $(that).parent().find("img").click(function () {
                    $(that).click();
                });
            });

        </script>
    {% endaddtoblock %}
</div>